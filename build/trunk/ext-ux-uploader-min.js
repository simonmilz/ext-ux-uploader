Ext.namespace("Ext.ux.uploader");Ext.ux.uploader.AbstractAdapter=function(a){Ext.ux.uploader.AbstractAdapter.superclass.constructor.call(this);this._initialConfig=a;Ext.apply(this,a);this.addEvents({uploadstart:true,uploadstop:true,uploadprogress:true,uploadsuccess:true,uploadfailure:true,queueerror:true,queueempty:true,filequeued:true,fileremoved:true,queuecomplete:true});this._features={queue:true,progress:false,pausequeue:true,pauseupload:false,filesize:false};if(this.imagesOnly){this.filters=[".jpg",".gif",".png",".bmp"]}this._init()};Ext.extend(Ext.ux.uploader.AbstractAdapter,Ext.util.Observable,{lang:{INVALID_FILETYPE:"Invalid File Type",EXCEEDS_MAXSIZE:"File exceeds maximum size of {0}"},_validFileName:function(a){var b=true;if(a==""){return false}if(this.filter&&Ext.type(this.filter)=="regexp"){b=this.filter.test(a);if(!b){return false}}else{if(this.filter&&Ext.type(this.filter)=="string"){if(!this.filters){this.filters=[this.filter]}else{if(Ext.type(this.filters)=="array"){this.filters[this.filters.length]=this.filter}}}}if(this.filters&&Ext.type(this.filters)=="array"){var c=new RegExp(("("+this.filters.join("|")+")$").replace(/\./,"."),"i");b=c.test(a)}return b},_basename:function(c){var a=c.replace(/^.*[\/\\]/g,"");if(typeof(suffix)=="string"&&a.substr(a.length-suffix.length)==suffix){a=a.substr(0,a.length-suffix.length)}return a},_init:function(){},hasFeature:function(a){return this._features[a]},browse:function(){},upload:function(a){},clearQueue:function(){},stop:function(a){},remove:function(a){},isUploading:function(){return this._uploading},isQueueEmpty:function(){return this._queue.getCount()==0},removeAt:function(a){},clearQueue:function(){},reset:function(){this.clearQueue()},getQueue:function(){},getCompleted:function(){},get:function(c,b){var a="_"+c;if(this[a]){return this[a]}return Ext.type(b)=="undefined"?false:b}});Ext.ux.uploader.AdapterFactory=(function(){var a={};return{register:function(b,c){a[b]=c},reg:function(b,c){this.register(b,c)},create:function(c,b){if(!a[c]){throw'Uploader Type "'+c+'" is not registered'}else{var d=new a[c](b);d.type=c;return d}}}})();Ext.ux.uploader.AbstractFileUpload=function(a){Ext.ux.uploader.AbstractFileUpload.superclass.constructor.call(this);this.addEvents({uploadstart:true,uploadsuccess:true,uploadpause:true,uploadfailure:true,uploaderror:true});this._initialConfig=a;Ext.apply(this,a);this._init();this._vars={}};Ext.extend(Ext.ux.uploader.AbstractFileUpload,Ext.util.Observable,{_init:function(){},getExt:function(){var a=this.getFilename();var b=a.match(/\.([a-zA-Z0-9]*)$/);return(b?b[1]:"").toLowerCase()},getType:function(){return Ext.ux.uploader.AbstractFileUpload.TYPES[this.getExt()]||"unknown"},canPreview:function(){return false},start:function(){},stop:function(){},getId:function(){return""},setVar:function(a,b){this._vars[a]=b},getVar:function(a){return this._vars[a]},getFilename:function(){return""},isUploading:function(){return false},isComplete:function(){return false},isPaused:function(){return false},getUploadedBytes:function(){return 0},getTotalBytes:function(){return 0},getSize:function(){return Ext.ux.uploader.Util.getSize(this.getTotalBytes())},getPercentUploaded:function(){return 0}});Ext.ux.uploader.AbstractFileUpload.TYPES={jpg:"image",gif:"image",png:"image",rtf:"document",doc:"document",docx:"document",pdf:"acrobat"};Ext.ux.uploader.Util={getSize:function(b){var e=["KB","MB","GB"];for(var c=e.length-1;c>=0;c--){var d=1024;for(var a=0;a<c;a++){d*=1000}if(b>d){var d=b/d;d=parseInt(d*100)/100;return d+" "+e[c]}}return b+" bytes"}};Ext.ux.uploader.HtmlAdapter=Ext.extend(Ext.ux.uploader.AbstractAdapter,{_init:function(){this._queue=new Ext.util.MixedCollection();this._queue.on("remove",this._onFileUploadRemoved,this);this._uploading=false;this._errorReader=this.decodeHtmlInResponse!==false?false:this._ErrorReader();this._completed=new Ext.util.MixedCollection();this._btn=this.button||new Ext.Button({buttonOnly:true});if(!this._btn.rendered){this._btn.on("render",this._onButtonRender,this)}else{this._onButtonRender()}this._paramKeys=Ext.apply({filename:"filename",file:"file"},this.paramKeys||{});delete this.paramKeys;this._queueEl=Ext.fly(document.body).createChild({tag:"div",style:"display:none"})},_onFileUploadRemoved:function(a){this.fireEvent("fileremoved",a);a.destroy();if(this._queue.getCount()==0){this.fireEvent("queueempty",this)}},_ErrorReader:function(a){a=a||{};return{read:function(f){f.responseText=f.responseText.replace(/\&lt\;/g,"<");f.responseText=f.responseText.replace(/\&gt\;/g,">");if(a.beforeDecode){a.beforeDecode.apply(a.scope||window,[f])}try{var b=Ext.decode(f.responseText)}catch(g){return{success:false,message:"Invalid response. Expected JSON string.",response:f.responseText}}var d=Ext.type(b);if(d=="string"||d=="element"){return{success:false}}b.records=[];for(var c in b.errors){b.records[b.records.length]={data:{id:c,msg:b.errors[c]}}}return b}}},_onButtonRender:function(){this._btn.getEl().addClass("x-form-file-btn");this._wrap=this._btn.getEl().wrap({cls:"x-form-file-wrap"});(function(){var a=this._btn.getEl().getWidth();this._wrap.setWidth(a)}).defer(20,this);this._createActiveFileInput()},_createActiveFileInput:function(){this._activeInput=this._wrap.createChild({tag:"input",type:"file",cls:"x-form-file",size:1});this._activeInput.hover(function(){this._btn.getEl().addClass("x-btn-over")}.createDelegate(this),function(){this._btn.getEl().removeClass("x-btn-over")}.createDelegate(this));this._activeInput.on("mousedown",this._onMouseDown,this);this._activeInput.on("mouseup",this._onMouseUp,this);this._activeInput.on("change",this._onFileSelected,this);return this._activeInput},_onMouseDown:function(a){if(!this.disabled&&a.button==0){this._btn.getEl().addClass("x-btn-click");Ext.getDoc().on("mouseup",this._onMouseUp,this)}},_onMouseUp:function(a){if(a.button==0){this._btn.getEl().removeClass("x-btn-over");this._btn.getEl().removeClass("x-btn-click");Ext.getDoc().un("mouseup",this._onMouseUp,this)}},_onFileSelected:function(){var b=this._basename(this._activeInput.dom.value);if(this._queue.containsKey(b)){return}if(!this._validFileName(b)){this._activeInput.dom.value="";this.fireEvent("queueerror",[{name:b,message:this.lang.INVALID_FILETYPE}]);return}this._activeInput.un("mousedown",this._onMouseDown,this);this._activeInput.un("mouseup",this._onMouseUp,this);this._activeInput.un("change",this._onFileSelected,this);var a=new Ext.ux.uploader.HtmlFileUpload({id:b,filename:b,uploader:this,input:this._activeInput});a.on("uploadsuccess",this._onUploadSuccess,this);a.on("uploadfailure",this._onUploadFailure,this);this._queue.add(b,a);this.fireEvent("filequeued",a);this._createActiveFileInput()},_upload:function(){var b=true;var a=0;this._queue.each(function(e,c,d){if(e.isUploading()){b=false;a++;return true}if(e.isComplete()){return true}e.start();if(!this._uploading){this._uploading=true;this.fireEvent("uploadstart",this)}b=false;a++;return this.maxRequests&&a<this.maxRequests},this);if(b!==false){if(this._uploading){this._uploading=false;this.fireEvent("uploadstop",this)}this.fireEvent("queueempty")}},_onUploadSuccess:function(a){this._queue.remove(a);this.fireEvent("uploadsuccess",this,a);a.destroy();this._upload()},_onUploadFailure:function(a){this.fireEvent("uploadfailure",this,a);file.uploading=false},upload:function(){this._upload()},removeAt:function(a){this._queue.removeAt(a)},remove:function(a){var b=this.isUploading();this._queue.remove(a);if(this.isQueueEmpty()){this.fireEvent("uploadstop",this)}else{if(b){this.upload()}}},clearQueue:function(){this._queue.each(function(a){this._queue.remove(a);a.destroy()},this)}});Ext.ux.uploader.AdapterFactory.reg("html",Ext.ux.uploader.HtmlAdapter);Ext.ux.uploader.HtmlFileUpload=Ext.extend(Ext.ux.uploader.AbstractFileUpload,{_init:function(){this._uploading=false;this._complete=false;var a=this.uploader.get("queueEl").createChild({tag:"form"});var b=new Ext.form.BasicForm(a,{fileUpload:true,errorReader:this.uploader.get("errorReader")});this.form=b;this.input.appendTo(a)},_onUploadSuccess:function(){this._uploading=false;this._complete=true;this.fireEvent("uploadsuccess",this)},_onUploadFailure:function(){this._uploading=false;this.fireEvent("uploadfailure",this)},start:function(){this.input.dom.name=this.uploader.get("paramKeys").file;var a=Ext.apply(this.uploader.extraParams||{});a[this.uploader.get("paramKeys").filename]=this.getFilename();this.form.submit({url:this.uploader.get("url"),params:a,scope:this,success:this._onUploadSuccess,failure:this._onUploadFailure});this._uploading=true;this.fireEvent("uploadstart",this)},destroy:function(){this.form.getEl().remove()},isUploading:function(){return this._uploading},isComplete:function(){return this._complete},getId:function(){return this.id},getFilename:function(){return this.filename}});Ext.ux.uploader.GearsAdapter=Ext.extend(Ext.ux.uploader.AbstractAdapter,{_init:function(){this._queue=new Ext.util.MixedCollection();this._queue.on("remove",this._onFileUploadRemoved,this);this._uploading=false;Ext.apply(this._features,{pauseupload:true,filesize:true,progress:true});this._paramKeys=Ext.apply({filename:"filename",start:"start",end:"end",total:"total",length:"length"},this.paramKeys||{});delete this.paramKeys;if(this.button){this.button.setHandler(this.browse,this)}this._maxRequests=this.maxRequests||false;this._complete=new Ext.util.MixedCollection();this._gearsDesktop=google.gears.factory.create("beta.desktop");this._gearsOpenFilesOptions=this.gearsOpenFilesOptions||{};this._chunkLength=this.chunkLength||20480;this._fullUpload=this.fullUpload||false;this._maxSize=false;if(this.filters){this._gearsOpenFilesOptions.filter=this.filters}if(this.singleFile){this._gearsOpenFilesOptions.singleFile=this.singleFile}if(this.maxSize){this._maxSize=this.maxSize}this._maxRetries=this.maxRetries||3;this._retries=0},_onFileUploadRemoved:function(a){this.fireEvent("fileremoved",a);a.destroy();if(this._queue.getCount()==0){this.fireEvent("queueempty",this)}},_getFileSignature:function(a){return[a.name,a.blob.length].join("-")},_onFilesQueued:function(d){var f=[];for(var c=0;c<d.length;c++){var e=this._getFileSignature(d[c]);if(this._queue.containsKey(e)){continue}if(this._maxSize&&d[c].blob.length>this._maxSize){var b=Ext.ux.uploader.Util.getSize(this._maxSize);f[f.length]={message:String.format(this.lang.EXCEEDS_MAXSIZE,b),name:d[c].name};continue}if(!this._validFileName(d[c].name)){f[f.length]={message:this.lang.INVALID_FILETYPE,name:d[c].name};continue}var a=new Ext.ux.uploader.GearsFileUpload({id:e,uploader:this,file:d[c],filename:this._basename(d[c].name)});a.on("uploadsuccess",this._onUploadSuccess,this);a.on("uploadfailure",this._onUploadFailure,this);this._queue.add(e,a);this.fireEvent("filequeued",a)}if(f.length>0){this.fireEvent("queueerror",f)}},_upload:function(a){var c=true;var b=0;this._queue.each(function(f,d,e){if(f.isUploading()){c=false;b++;return true}if(f.isComplete()){return true}f.start();if(!this._uploading){this._uploading=true;this.fireEvent("uploadstart",this)}c=false;b++;return this.maxRequests&&b<this.maxRequests},this);if(c!==false){if(this._uploading){this._uploading=false;this.fireEvent("uploadstop",this)}this.fireEvent("queuecomplete")}},_onUploadSuccess:function(a){this.fireEvent("uploadsuccess",this,a);var b=this._queue.remove(a);this._upload()},_onUploadFailure:function(a){this.fireEvent("uploadfailure",this,a)},reset:function(){this._queue.each(function(a){this._queue.remove(a)})},browse:function(){this._gearsDesktop.openFiles(this._onFilesQueued.createDelegate(this),this._gearsOpenFilesOptions)},remove:function(a){var b=this.isUploading();this._queue.remove(a);if(this.isQueueEmpty()){this.fireEvent("uploadstop",this)}else{if(b){this.upload()}}},removeAt:function(a){this._queue.removeAt(a)},clearQueue:function(){this._queue.each(function(a){this._queue.remove(a);a.destroy()},this)},upload:function(a){this._upload(a)},pause:function(){this._gearsRequests.each(function(c,b){var a=this._queue.get(b);try{a.uploading=false;c.abort();this._gearsRequests.removeKey(b)}catch(d){this.console.log(d)}},this);this._isUploading=false},togglePause:function(){if(this._isUploading){this.pause()}else{this.upload()}},getComplete:function(){return this._complete},getRequestsCount:function(){return this._gearsRequests.getCount()}});Ext.ux.uploader.AdapterFactory.reg("gears",Ext.ux.uploader.GearsAdapter);Ext.ux.uploader.GearsFileUpload=Ext.extend(Ext.ux.uploader.AbstractFileUpload,{_init:function(){this._request=null;this._uploading=false;this._uploaded=0;this._requestProgress=0;this._requestLength=0;this._complete=false;this._chunkLength=this.uploader.get("chunkLength");this._fullUpload=this.uploader.get("fullUpload");this._maxRetries=this.uploader.get("maxRetries");this._retries=0;if(this.canPreview()&&this.uploader.usePreview){try{var c=google.gears.factory.create("beta.localserver");var a=c.createStore("ux-uploader-gears-adapter");this._previewUrl=this.getFilename()+this.getFilesize();a.captureBlob(this.file.blob,this._previewUrl)}catch(b){console.log(b.message)}}},start:function(){if(!this.isUploading()&&!this.isComplete()){this._uploading=true;this.fireEvent("uploadstart",this);this._sendChunk()}},_getUploadInfo:function(){var a={};a.start=this._uploaded+(this._requestProgress);a.total=this.file.blob.length;a.end=this.uploader.get("fullUpload")?a.total:Math.min(this._uploaded+this._chunkLength,a.total);a.length=a.end-this._uploaded;a.percent=a.start/a.total;return a},_sendChunk:function(){var f=this._getUploadInfo();if(this._request){delete this._request}this._request=google.gears.factory.create("beta.httprequest");this._request.onreadystatechange=this._onReadyStateChange.createDelegate(this);this._request.upload.onprogress=this._onUploadProgress.createDelegate(this);var d={"Content-Disposition":"attachment; filename='"+this.getFilename()+"'","Content-Type":"application/octet-stream","Content-Range":"bytes "+f.start+"-"+f.end+"/"+f.total};var g={};var e=this.uploader.get("paramKeys");for(var c in e){val=(c=="filename")?this.getFilename():(f[c]||"");g[e[c]]=val}var b=this.uploader.get("url")||"?";g=Ext.urlEncode(Ext.apply(g,this.uploader.extraParams||{}));b+=((b.indexOf("?")!=-1?"&":"?")+g);this._request.open("POST",b);for(var a in d){if(d.hasOwnProperty(a)){this._request.setRequestHeader(a,d[a])}}this._requestProgress=0;f=this._getUploadInfo();this._request.send((f.start==0&&f.end==f.total)?this.file.blob:this.file.blob.slice(f.start,f.length));return this._request},_onReadyStateChange:function(b){try{if(this._request.readyState==4){this._uploading=false;switch(this._request.status){case 200:try{this._retries=0;var a=Ext.decode(this._request.responseText);var d=this._getUploadInfo();this._uploaded+=d.length;this._requestProgress=0;this.fireEvent("uploadprogress",this,this._getUploadInfo());d=this._getUploadInfo();if(this._uploaded==d.total){this._complete=true;this.fireEvent("uploadsuccess",this)}else{this._sendChunk()}}catch(c){console.log(c)}break;default:if(this._retries<this._maxRetries){this._sendChunk();retries++}else{this.fireEvent("uploaderror",this)}}}}catch(c){console.log(c)}},_onUploadProgress:function(a){try{this._requestProgress=a.loaded;this.fireEvent("uploadprogress",this,this._getUploadInfo())}catch(b){console.log(b)}},getPreviewUrl:function(){return this._previewUrl||false},getFilename:function(){return this.filename},getFilesize:function(){return this.file.blob.length},destroy:function(){if(this.isUploading()){this._request.abort()}if(this.canPreview()&&this.uploader.usePreview){var b=google.gears.factory.create("beta.localserver");var a=b.createStore("ux-uploader-gears-adapter");a.remove(this.getPreviewUrl())}},getTotalBytes:function(){return this.file.blob.length},isUploading:function(){return this._uploading},isComplete:function(){return this._complete},getId:function(){return this.id},canPreview:function(){return this.getType()=="image"}});Ext.ux.uploader.Panel=Ext.extend(Ext.Panel,{initComponent:function(){this._addFilesBtn=new Ext.Button({text:"Add Files",cls:"x-btn-text-icon",iconCls:"add-icon"});if(this.usePreview){this.previewWidth=this.previewWidth||50;this.previewHeight=this.previewHeight||40}this.autoScroll=this.autoScroll===false?false:true;this._adapterType=this.adapter||this.adapterType||"html";this._uploader=Ext.ux.uploader.AdapterFactory.create(this._adapterType,Ext.apply({button:this._addFilesBtn,url:"?",maxRequests:1,chunkLength:51200},this.initialConfig));if(!this._uploader){throw"Uploader Adapter could not be found: "+this._adapterType}this.tbar=[this._addFilesBtn];if(this.hideUploadBtn!==false){this._uploadBtn=new Ext.Button({text:"Upload",handler:this._uploader.upload,scope:this._uploader,cls:"x-btn-text-icon",iconCls:"upload-icon",disabled:true});this.tbar+=["-",this._uploadBtn]}this._statusBar=new Ext.StatusBar({defaultText:"",busyText:"Uploading..."});this.bbar=this._statusBar;if(!this.entryTpl){this.entryTpl=new Ext.XTemplate('<div class="x-upload-panel-entry">','<div class="x-upload-panel-entry-pad">','<div class="x-upload-panel-entry-buttons"></div>','<div class="x-upload-panel-entry-preview"></div>','<div class="x-upload-panel-entry-icon"><span class="x-upload-panel-icon"></span></div>','<div class="x-upload-panel-entry-progress"></div>','<div class="x-upload-panel-entry-title">',"<span>{name}</span>","</div>",'<div class="x-upload-panel-entry-clear"></div>',"</div>","</div>")}this._uploader.on("filequeued",this._onFileQueued,this);this._uploader.on("fileremoved",this._onFileRemoved,this);this._uploader.on("queueerror",this._onQueueError,this);this._uploader.on("queueempty",this._onQueueEmpty,this);this._uploader.on("uploadstart",this._onUploaderStart,this);this._uploader.on("uploadstop",this._onUploaderStop,this);Ext.ux.uploader.Panel.superclass.initComponent.call(this);this.exposeMethods(this._uploader,["browse","upload","reset","isQueueEmpty"]);this.relayEvents(this._uploader,["queuecomplete","uploadstart","uploadstop","queueempty","filequeued","fileremoved","uploadsuccess"])},_onFileQueued:function(b){b.on("uploadprogress",this._onFileUploadProgress,this);b.on("uploadstart",this._onFileUploadStart,this);var a=b.getFilename();if(this._uploader.hasFeature("filesize")){a+=" ("+b.getSize(true)+")"}var c=Ext.get(this.entryTpl.append(this.body,{name:a}));this._initEntry(c,b);b.setVar("panelEl",c);if(this._uploadBtn){this._uploadBtn.enable()}this.doLayout()},_onFileRemoved:function(a){var b=a.getVar("panelEl").remove();delete b},_initEntry:function(d,b){d.buttons=d.child(".x-upload-panel-entry-buttons");d.progress=d.child(".x-upload-panel-entry-progress");d.title=d.child(".x-upload-panel-entry-title");d.icon=d.child(".x-upload-panel-entry-icon");d.preview=d.child(".x-upload-panel-entry-preview");d.pad=d.child(".x-upload-panel-entry-pad");var c=b.getType();if(c!=="unknown"){d.icon.addClass(c+"-icon")}if(b.canPreview()&&this.usePreview){d.preview.setStyle({display:"block"});d.icon.setStyle({display:"none"});var a=new Image();a.onload=function(){var f=a.width,i=a.height,e,g;if(f>i){e=this.previewWidth;g=parseInt(a.height*(this.previewWidth/f))}else{g=this.previewHeight;e=parseInt(a.width*(this.previewHeight/i))}d.preview.createChild({tag:"img",src:b.getPreviewUrl(),width:e,height:g})}.createDelegate(this);a.src=b.getPreviewUrl()}d.removeIcon=d.buttons.createChild({tag:"img",src:Ext.BLANK_IMAGE_URL,cls:"icon remove-icon"});d.removeIcon.on("click",function(){this._uploader.remove(b)},this)},_onQueueError:function(b){var a="";if(b.length>1){a="Error adding some of the selected files"}else{a=b[0].name+": "+b[0].message}this._statusBar.setStatus({text:a,iconCls:"error-icon",clear:{wait:3000,anim:true}})},_onFileUploadStart:function(a){var b=a.getVar("panelEl");b.icon.removeClass("page-icon");b.icon.addClass("loading-icon");if(!this._uploader.hasFeature("progress")){b.addClass("loading-bg")}},_onUploaderStart:function(a){if(this._uploadBtn){this._uploadBtn.disable()}this._statusBar.showBusy()},_onUploaderStop:function(a){if(!this._uploader.isQueueEmpty()){if(this._uploadBtn){this._uploadBtn.enable()}}this._statusBar.clearStatus({useDefaults:true})},_onQueueEmpty:function(a){if(this._uploadBtn){this._uploadBtn.disable()}},_onFileUploadProgress:function(b,e){var c=b.getVar("panelEl");var d=Ext.fly(c).child(".x-upload-panel-entry-pad");var a=Ext.fly(c).child(".x-upload-panel-entry-progress");c.progress.setHeight(c.pad.getHeight());c.progress.setWidth(parseInt(100*e.percent)+"%")},exposeMethods:function(c,b){if(Ext.type(b)=="string"){b=[b]}if(!Ext.type(b)=="array"){return}for(var d=0;d<b.length;d++){var a=b[d];this[a]=c[a].createDelegate(c)}},getUploader:function(){return this._uploader}});